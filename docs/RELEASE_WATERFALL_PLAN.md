# Aegis 正式产品发布瀑布计划（Release Waterfall）

## 1. 现状结论（基于当前 C2 进度）
当前版本已达到“可运行的 C2 存储升级阶段”，但尚未达到正式产品发布标准。

已完成（可用但非最终）：
- 索引/正文分离（`messages` + `content_blobs`）
- 列表读索引、详情按需读取正文
- 正文缓存与 LRU（仅淘汰 blob，不删索引）
- C1 治理一致性修复与自动化门禁

关键缺口（必须补齐后才可发布）：
- 缺少真正“网络回源”（本地 miss 时向 peers 拉取 `content_cid`）
- 缺少反熵同步（离线节点回归后自动补齐索引与正文）
- 缺少图片/媒体链路（CID、缩略图、压缩、去重）
- 缺少互联网连通能力（NAT 穿透/中继/公网引导节点）
- 缺少发布级观测与告警（回源失败率、同步延迟、缓存命中率）
- 缺少发布级稳定性门禁（长稳压测、故障恢复、迁移回滚）

---

## 2. 瀑布执行规则（发布版）
1) 严格顺序：R1 → R2 → R3 → R4 → R5 → R6，不跳阶段。
2) 入口条件：上一阶段 Done + 本阶段 API/协议冻结。
3) 出口条件：自动化通过 + 三节点手工联调通过 + 文档同步。
4) 变更控制：阶段内发现新需求只记录到后续阶段，不插入当前阶段。

发布 UX 硬约束：
- 不要求用户手动点击“Start P2P”。
- 应用启动后自动进入“可连接/可同步”状态（失败可见、可重试，但默认自动启动）。
- 本地多实例调试时，端口冲突需自动回退到可用端口，避免要求用户手动改端口。

---

## 3. 发布阶段分解

## R1：网络回源（必须先做）
### 目标
本地正文缺失时，可从网络按 `content_cid` 自动拉取并回填本地。

### 任务
- 新增 P2P 内容请求/响应协议：
  - `CONTENT_FETCH_REQUEST { content_cid, request_id }`
  - `CONTENT_FETCH_RESPONSE { content_cid, body, size_bytes, found, request_id }`
- 本地 `GetPostBodyByCID` 逻辑改为：
  - 先本地查；miss 时触发网络回源；成功后落 `content_blobs` 再返回。
- 增加超时、重试、并发去重（同一 `content_cid` 只发一次网络请求）。

### DoD
- 任何节点只要有索引且网络中存在正文副本，详情可自动打开。

### 验证
- A 发布帖子，B 删除本地该 blob 后点击详情，能自动回源成功。

---

## R2：反熵同步（离线回归一致性）
### 目标
节点离线后重连，能自动补齐缺失索引与正文，避免“看得到标题看不到正文”。

### 任务
- 摘要交换（例如按时间窗/批次交换 `post_id/content_cid` 列表）。
- 缺口补齐流程：缺啥补啥（先索引后正文）。
- 后台周期任务：定时补齐 + 失败重试。

### DoD
- 离线节点回归 5 分钟内，关键内容可收敛。

### 验证
- B 断网期间 A 连续发帖，B 重连后自动补齐。

---

## R3：媒体链路（图片最小闭环）
### 目标
支持图片帖正式可用，不依赖 base64 落库。

### 任务
- 模型落地：`image_cid/thumb_cid/mime/size/width/height`。
- 上传前压缩与格式策略（优先 WebP/AVIF，失败回退）。
- 同图去重（哈希/CID 相同只存一份）。
- 列表优先缩略图，详情按需原图。

### DoD
- 图片在三节点可见；重复上传占用不线性增长。

### 验证
- 同图重复发帖，存储增长明显低于线性。

---

## R4：互联网连通与安全（LAN -> WAN）
### 目标
节点不仅能在局域网发现彼此，还能在公网稳定互联并具备基础抗滥用能力。

### 任务
- 零手动启动：
  - 应用启动自动拉起 P2P（端口与引导节点可配置）。
  - UI 仅保留诊断与重连能力，不把“手动启动网络”作为主路径。
- 连通能力：
  - 引入公网 bootstrap 节点（多地域，至少 3 个）
  - 启用 NAT 检测与打洞（AutoNAT / hole punching）
  - 打洞失败时自动回退 relay v2 中继
- 地址与发现：
  - 节点上报可达地址策略（避免仅上报内网地址）
  - 区分 LAN mDNS 与 WAN 引导发现通道
- 安全与防滥用：
  - 连接级限速、请求级限流（含 `CONTENT_FETCH`）
  - 黑名单/灰名单策略与短时封禁
  - 基础资源防护（单 peer 并发/带宽上限）

### DoD
- 新用户首次打开应用，不做手动网络操作即可看到节点进入联网状态（或明确失败原因）。
- 两个不同公网网络下的节点可互联、可同步、可回源。
- 在打洞失败场景可自动通过 relay 回退并保持可用。

### 验证
- 使用两台不同公网环境主机做端到端联调。
- 人工模拟 NAT 严格场景，验证 relay 回退成功。

---

## R5：发布级稳定性与观测
### 目标
具备可运维能力，出现问题能定位、能告警、能恢复。

### 任务
- 指标：
  - `content_fetch_success_rate`
  - `content_fetch_latency_p95`
  - `blob_cache_hit_rate`
  - `sync_lag_seconds`
- 结构化日志：回源请求、失败原因、重试次数。
- 关键告警阈值与手工排障手册。

### DoD
- 能在 10 分钟内定位“详情打不开”根因。

### 验证
- 人为制造回源失败，日志和指标可准确反映。

---

## R6：发布门禁与灰度
### 目标
建立可重复发布流程，降低线上事故概率。

### 任务
- 测试门禁：
  - 单测 + 三节点集成测试 + 回归脚本
  - 长稳测试（持续发帖/评论/回源）
- 数据迁移门禁：
  - 迁移演练
  - 回滚脚本
- 灰度发布：
  - 单节点灰度 -> 小规模 -> 全量

### DoD
- 连续两轮灰度无阻断问题，才允许全量。

### 验证
- 按灰度脚本执行一次完整演练并留档。

---

## 4. 建议里程碑（简版）
- M1（R1 完成）：正文“本地 miss 可网络回源”
- M2（R2 完成）：离线节点回归自动补齐
- M3（R3 完成）：图片链路可用
- M4（R4 完成）：具备公网互联与 relay 回退能力
- M5（R5 完成）：发布级可观测
- M6（R6 完成）：具备正式发布条件

---

## 5. 与现有任务清单关系
- `docs/ENHANCEMENT_TASKS.md` 继续记录 A/B/C 功能演进状态。
- 本文档用于“从可运行到可发布”的发布瀑布计划。
- 两份文档同时维护：功能进度（Enhancement）+ 发布就绪（Release）。
