# Aegis 成熟版瀑布计划（用户高频优先）

## 1. 目标

在不引入广告系统的前提下，将 Aegis 从“可用原型”推进到“成熟论坛产品”。

执行原则：

- 严格瀑布顺序，不跳阶段。
- 每次只做一个阶段内的功能。
- 每完成一个阶段，必须：更新文档 -> 完整测试 -> 推送。

## 1.1 工程实施硬性要求（新增）

在每个阶段的设计与编码中，必须遵守以下标准：

1. 角色要求
- 以全栈开发专家与架构专家标准执行，不只修功能，还要保证系统一致性与可演进性。

2. 文档先行与回顾
- 编码前必须回顾相关文档（本计划、API/数据模型文档、现有治理与同步文档）。
- 每一步实现前先确认：目标、边界、依赖、回归影响面。

3. 每步优化意识
- 每完成一个子步骤，进行一次小型优化检查：
  - 代码重复是否可消除；
  - 命名与模块边界是否清晰；
  - 错误处理与日志是否可排障；
  - 性能与可维护性是否可接受。

4. 最佳实现原则
- 默认选择长期可维护的实现，不采用临时补丁式写法。
- 关键路径优先保证：正确性 > 稳定性 > 可观测性 > 性能。

5. 代码洁癖标准
- 保持单一职责、低耦合、可测试。
- 严禁无用代码、重复逻辑、隐式魔法值、弱语义命名。
- 新增代码必须与现有风格一致，必要时同步进行小范围重构。

6. 质量门禁强化
- 阶段结束前，除原有测试门禁外，必须通过“实现质量自检”：
  - 架构一致性检查（是否破坏模块边界）；
  - 回归风险清单检查（高频路径是否受影响）；
  - 文档与实现一致性检查（文档是否同步更新）。

---

## 2. 阶段顺序（冻结）

### Phase 1 - 核心体验打磨（P0）

目标：优先优化用户最高频链路（发帖、看帖、评论、切换）。

范围：

1. 发帖/评论交互反馈统一（加载态、错误态、成功态）。
2. 详情与列表状态一致性（删除/编辑/投票后刷新一致）。
3. 首屏与常用视图切换体验优化（Feed/Discover/PostDetail）。

DoD：

- 新用户 5 分钟内可完成“发帖 + 评论 + 收藏 + 返回列表”闭环。
- 不出现明显状态错乱（列表有、详情无，或反之）。

### Phase 2 - 通知中心（P0）

目标：上线高频留存能力（回复、@、系统通知）。

范围：

1. 通知模型与存储。
2. 未读/已读、批量已读。
3. 通知点击跳转定位（帖子/评论）。

DoD：

- 关键互动事件可稳定到达通知中心。
- 点击通知可定位到正确内容。

### Phase 3 - 搜索与发现增强（P1）

目标：提升“找内容”效率。

范围：

1. 搜索结果筛选（Sub/作者/时间）。
2. 排序增强（New/Hot/Top: day/week/month/all）。
3. 结果分页与空态优化。

DoD：

- 常见检索路径 3 次内可命中目标内容。

### Phase 4 - 社区运营工具（P1）

目标：让社区管理员可日常运营。

范围：

1. 置顶、加精、锁帖。
2. 社区规则页与公告区。
3. 管理动作日志可追踪。

DoD：

- 管理员可独立完成一次“公告 + 置顶 + 锁帖”操作闭环。

### Phase 5 - 举报审核闭环（P1）

目标：建立完整内容治理流程。

范围：

1. 举报入口（帖子/评论/用户）。
2. 审核队列与处理动作。
3. 举报状态回执。

DoD：

- 举报 -> 受理 -> 处理 -> 回执全链路可追踪。

### Phase 6 - 可靠性与可观测性强化（P0）

目标：把异常从“偶发现象”变成“可检测、可恢复、可回归”。

范围：

1. 关键链路重试与错误分级。
2. 双节点/三节点自动回归门禁。
3. 关键同步与发布指标埋点。

DoD：

- 发布/同步异常可定位、可复现、可回归。

### Phase 7 - 反垃圾与风控（P1）

目标：降低灌水和恶意内容干扰。

范围：

1. 发帖/评论频率限制。
2. 短时重复内容拦截。
3. 新号冷启动限制策略。

DoD：

- 常见刷屏路径被稳定限制，误伤可控。

### Phase 8 - 发布与运维标准化（P0）

目标：形成稳定发布节奏与回滚能力。

范围：

1. 发布检查清单（功能、数据、回滚）。
2. 故障分级与处理预案。
3. 版本记录与变更审计。

DoD：

- 每次发布具备可回滚与可追踪记录。

---

## 3. 阶段执行模板（每阶段固定）

1. 设计冻结
- 确认数据模型、API、UI、验收用例。

2. 实现
- 严禁混入后续阶段需求。

3. 文档更新
- 将当前阶段从 `In Progress` 更新为 `Done`。
- 记录变更摘要与关键决策。

4. 完整测试

```bash
cd aegis-app && go test ./...
cd aegis-app/frontend && npm run build
cd aegis-app && ./scripts/run_g6_gate_checks.sh
```

并执行手工联调清单（至少双节点）：

- 发帖、评论、删除、收藏、同步一致性。
- 当前阶段新增能力的主流程/异常流程。

5. 推送

```bash
git add -A
git commit -m "phase-x: <功能名> complete with full validation"
git push origin master
```

---

## 4. 当前状态

- Phase 1: Done
- Phase 2: Pending
- Phase 3: Pending
- Phase 4: Pending
- Phase 5: Pending
- Phase 6: Pending
- Phase 7: Pending
- Phase 8: Pending

### Phase 1 执行拆分（顺序）

1. P1-S1 基线代码完整性修复（Done）
2. P1-S2 发布/评论反馈统一（loading/success/error）（Done）
3. P1-S3 列表-详情状态一致性收敛（Done）
4. P1-S4 高频视图切换体验优化（Done）

### Phase 1 进展记录

- 2026-02-28 / P1-S1 Done
  - 修复前端阻塞构建问题：`App.tsx`、`CommentTree.tsx` 重复模块拼接导致的大量 TS Duplicate Identifier 报错。
  - 修复设置页资料发布参数调用不一致问题（`SettingsPanel`）。
  - 验证通过：`go test ./...`、`frontend npm run build`、`./scripts/run_g6_gate_checks.sh`。
  - 影响：恢复可持续迭代的前端基线，为后续 Phase 1 体验优化提供稳定起点。

- 2026-02-28 / P1-S2 Done
  - 统一发布与回复错误反馈：创建 Sub、创建 Post、回复评论、删除帖/评在失败时展示明确错误信息。
  - 为创建 Sub 补充提交中状态（按钮禁用与 `Creating...`）、失败信息展示，避免重复点击和无反馈。
  - 验证通过：`go test ./...`、`frontend npm run build`、`./scripts/run_g6_gate_checks.sh`。
  - 影响：高频操作的异常可读性与交互确定性明显提升，减少“点击了但不知道发生什么”的体验问题。

- 2026-02-28 / P1-S3 Done
  - 新增 `viewSyncToken` 作为列表与详情状态一致性同步令牌，覆盖创建、删除、投票、收藏和远端 `feed/favorites` 事件。
  - `MyPosts` 与 `Favorites` 增加 `refreshToken` 驱动的重新拉取，避免详情操作后列表残留旧状态。
  - 验证通过：`go test ./...`、`frontend npm run build`、`./scripts/run_g6_gate_checks.sh`。
  - 影响：跨视图（Feed/My Posts/Favorites/Post Detail）状态更新更加一致，减少“详情变了但列表没变”的错位。

- 2026-02-28 / P1-S4 Done
  - 为 `MyPosts` 与 `Favorites` 增加按用户缓存与快速回显机制，减少高频视图切换时的重复加载闪烁。
  - 保留 `refreshToken` 驱动增量刷新，确保缓存命中时仍能在数据变更后及时收敛。
  - 验证通过：`go test ./...`、`frontend npm run build`、`./scripts/run_g6_gate_checks.sh`。
  - 影响：Feed/My Posts/Favorites 之间切换更顺滑，交互感知延迟降低。
