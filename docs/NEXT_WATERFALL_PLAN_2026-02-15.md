# Aegis 下一阶段总瀑布计划（2026-02-15）

## 1. 文档目的
本文件作为新的主执行文档，承接已完成阶段后的后续开发。  
旧文档（A/B/C、R、S）转为归档与追溯，不再作为主排期来源。

执行原则：先文档冻结，再实现代码，再验收关口。

---

## 2. 已完成阶段归档
以下阶段按“已完成”处理，不再重复拆分：
- 功能主线：A1-A4、B1-B3、C1-C2
- 发布主线：R1-R5
- 订阅搜索主线：S1-S6（后端）

说明：
- 这些阶段对应能力已落地到代码与历史文档。
- 后续仅做缺陷修复与回归，不在本计划中重复立项。

---

## 3. 新主线（N 系列）
从本文件开始，统一使用 `N1 -> N6`。

## N1：后端产品化收口（订阅/搜索/FeedStream）
### 目标
把已完成后端能力做成稳定可复用的后端服务能力。

### 任务
0. 先执行前后端 API 对账清单：`docs/FRONTEND_BACKEND_API_GAP_WATERFALL_2026-02-16.md`（G0-G6）。  
1. 订阅管理 API 完整化与幂等性回归。  
2. 搜索 API 稳定化（参数校验、边界行为、性能基线）。  
3. FeedStream API 稳定化（分页、去重、混排一致性）。  
4. 事件规范冻结：`subs:subscriptions_updated`、`sub:updated`。  
5. 后端接口契约文档与回归脚本完善。  
6. 帖子收藏能力按专项瀑布推进：`docs/POST_FAVORITES_WATERFALL_PLAN.md`（F1-F5，索引跨设备同步、正文私有缓存不占共享区）。
7. P2P 中继角色冻结：每个节点默认启用 relay 能力；具备公网 IP 的节点可充当 relay，内网节点在打洞失败时自动回退 relay 链路。

### DoD
- 后端可独立提供“订阅 -> 推送 -> 搜索 -> 混合流”完整链路。  
- 公网节点可作为中继节点参与转发，受限网络节点在 relay 回退下保持可用。

### 验证
- 三节点手工联调通过（A 发帖，B/C 接口返回与推送正确）。

---

## N2：推荐策略插件化（替换 hot-v1）
### 目标
在不改接口的前提下支持推荐策略扩展与灰度切换。

### 任务
1. 固化策略接口层（策略注册、打分、回退）。  
2. 增加策略配置入口（环境变量/配置表）。  
3. 增加 debug 输出（每条推荐的打分解释）。  
4. 保留 `hot-v1` 作为兜底策略。  

### DoD
- 可在运行时选择策略名，接口返回 `algorithm` 与可解释得分。  

### 验证
- 切换策略后流结果发生可预期变化，回退可用。  

---

## N3：发布闭环（R6）
### 目标
完成正式发布前的最后门禁与灰度流程。

### 任务
1. 完成长稳测试与故障演练。  
2. 完成迁移回滚演练与发布脚本。  
3. 完成灰度策略：单节点 -> 小规模 -> 全量。  

### DoD
- 连续两轮灰度无阻断问题。  

### 验证
- 按发布脚本执行完整演练并留档。  

---

## N4：搜索质量与性能升级
### 目标
把 V1 `LIKE` 搜索升级到可扩展方案。

### 任务
1. 引入 SQLite FTS5（或等价索引方案）。  
2. 支持权重排序（标题高于正文）。  
3. 增加高频查询保护（缓存/节流）。  

### DoD
- 搜索结果相关性与响应时间稳定提升。  

### 验证
- 基准样本集对比 V1，命中率和耗时可量化提升。  

---

## N5：推荐系统外部化接入（可选）
### 目标
预留并支持接入外部推荐服务（如 Gorse/自研服务）。

### 任务
1. 候选集与特征抽取层。  
2. 外部服务调用适配器与失败回退。  
3. 观测指标：命中率、点击反馈、延迟。  

### DoD
- 外部推荐可灰度启用，失败自动回退 `hot-v1`。  

### 验证
- 压测与故障注入下服务可降级不阻断主流程。  

---

## N6：文档与流程治理
### 目标
保证后续迭代持续遵循瀑布纪律。

### 任务
1. 每阶段入口前冻结：需求、API、验收用例。  
2. 每阶段出口后更新：状态、回归结果、风险项。  
3. 变更单机制强制执行（跨阶段插单必须留痕）。  

### DoD
- 任一新功能都能追溯“文档 -> 实现 -> 验收”。  

### 验证
- 抽样检查 3 个任务链路可完整追踪。  

---

## 4. 瀑布关口模板（统一）
### 入口条件
- 上一阶段 `Done`。  
- 本阶段 API 和范围冻结。  
- 验证清单已准备。  

### 出口条件
- 代码完成并通过自动化校验。  
- 三节点手工联调通过。  
- 本文档状态更新为 `Done`。  

---

## 5. 当前状态（2026-02-15）
- N1：Pending
- N2：Pending
- N3：Pending
- N4：Pending
- N5：Pending
- N6：In Progress

---

## 6. 后续执行约束
1. 新需求必须先更新本文件对应阶段，再开始编码。  
2. 未写入阶段文档的需求，不进入实现。  
3. 如需调整顺序，必须先记录变更单（原因、影响、回归点）。  
4. 当前协作边界：仅后端业务与后端文档，前端实现不在本计划范围内。  
