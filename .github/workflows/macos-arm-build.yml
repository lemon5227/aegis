name: Build macOS ARM App

on:
  workflow_dispatch:
    inputs:
      publish_draft_release:
        description: "Publish artifacts to draft prerelease"
        required: false
        default: false
        type: boolean
      draft_tag_name:
        description: "Draft prerelease tag name"
        required: false
        default: "beta-draft"
        type: string
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "**/*.md"
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-macos-arm:
    runs-on: macos-14
    defaults:
      run:
        working-directory: aegis-app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: aegis-app/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: aegis-app/frontend/package-lock.json

      - name: Install Wails CLI
        shell: bash
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0

      - name: Prepare shield app icon (icns)
        shell: bash
        run: |
          ICON_SRC="frontend/src/assets/images/logo-universal.png"
          if [ ! -f "$ICON_SRC" ]; then
            echo "Icon source not found: $ICON_SRC"
            exit 1
          fi
          mkdir -p build/darwin build/icon.iconset
          sips -z 16 16     "$ICON_SRC" --out build/icon.iconset/icon_16x16.png >/dev/null
          sips -z 32 32     "$ICON_SRC" --out build/icon.iconset/icon_16x16@2x.png >/dev/null
          sips -z 32 32     "$ICON_SRC" --out build/icon.iconset/icon_32x32.png >/dev/null
          sips -z 64 64     "$ICON_SRC" --out build/icon.iconset/icon_32x32@2x.png >/dev/null
          sips -z 128 128   "$ICON_SRC" --out build/icon.iconset/icon_128x128.png >/dev/null
          sips -z 256 256   "$ICON_SRC" --out build/icon.iconset/icon_128x128@2x.png >/dev/null
          sips -z 256 256   "$ICON_SRC" --out build/icon.iconset/icon_256x256.png >/dev/null
          sips -z 512 512   "$ICON_SRC" --out build/icon.iconset/icon_256x256@2x.png >/dev/null
          sips -z 512 512   "$ICON_SRC" --out build/icon.iconset/icon_512x512.png >/dev/null
          sips -z 1024 1024 "$ICON_SRC" --out build/icon.iconset/icon_512x512@2x.png >/dev/null
          iconutil -c icns build/icon.iconset -o build/darwin/iconfile.icns

      - name: Build macOS arm64 app
        shell: bash
        run: |
          export PATH="$HOME/go/bin:$PATH"
          BOOTSTRAP='${{ secrets.AEGIS_BOOTSTRAP_PEERS }}'
          RELAY='${{ secrets.AEGIS_RELAY_PEERS }}'
          LDFLAGS=""
          if [ -n "$BOOTSTRAP" ]; then
            LDFLAGS="$LDFLAGS -X 'main.defaultBootstrapPeersCSV=$BOOTSTRAP'"
          fi
          if [ -n "$RELAY" ]; then
            LDFLAGS="$LDFLAGS -X 'main.defaultRelayPeersCSV=$RELAY'"
          fi
          if [ -n "$LDFLAGS" ]; then
            wails build -platform darwin/arm64 -ldflags "$LDFLAGS"
          else
            wails build -platform darwin/arm64
          fi

      - name: Package artifact
        shell: bash
        run: |
          APP_BUNDLE="$(ls -d build/bin/*.app | head -n 1)"
          if [ -z "$APP_BUNDLE" ]; then
            echo "No .app bundle found in build/bin"
            ls -la build/bin || true
            exit 1
          fi

          # Ad-hoc sign to reduce Gatekeeper corruption warnings
          codesign --force --deep --sign - "$APP_BUNDLE"

          hdiutil create -volname "Aegis" -srcfolder "$APP_BUNDLE" -ov -format UDZO build/bin/aegis-app-macos-arm64.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-app-macos-arm64
          path: |
            aegis-app/build/bin/aegis-app-macos-arm64.dmg
            aegis-app/build/bin/*.app
          if-no-files-found: error

      - name: Publish release assets
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            aegis-app/build/bin/aegis-app-macos-arm64.dmg
          overwrite_files: true

      - name: Publish draft prerelease assets
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.publish_draft_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.draft_tag_name }}
          name: ${{ github.event.inputs.draft_tag_name }} (manual draft)
          draft: true
          prerelease: true
          files: |
            aegis-app/build/bin/aegis-app-macos-arm64.dmg
          overwrite_files: true
